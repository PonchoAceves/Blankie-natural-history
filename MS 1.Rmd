---
title: "R Notebook"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Novel decorating behaviour of silk retreats in a challenging habitat

**Authors:**

Alfonso Aceves-Aparicio\*^1, 2^, Donald James McLean^1^, Zoe Korzy Wild^1^, Jutta M. Schneider^2^ and Marie E. Herberstein^1^

1, Department of Biological Sciences, Macquarie University, Sydney, NSW, 2109, Australia

2, Institute of Zoology, Universität Hamburg, Hamburg, Germany Corresponding author: Alfonso Aceves-Aparicio Correspondence: [bioarach\@gmail.com](mailto:bioarach@gmail.com){.email}

This is the code used to extract velocity data and generate figures from the attacked sequences recorded as high speed video.

Document setup: Libraries and Data

```{r R Packages, message=FALSE}
library(tidyverse)
library(pavo)
library(printr)
library(DT)
library(kableExtra)
library(plotrix)
library(cowplot)

source("R/functions.R")
```

```{r}
# getwd()
# dir()
# ls()
# rm(list=ls())
```

## Natural history data

```{r}
all <- read.csv("Data/all-surveys.csv", stringsAsFactors = F)
# all %>% kbl() %>% kable_classic() %>% scroll_box(width = "100%", height = "400px")

```

```{r}


# all %>% 
#   select(-c(occu, collected, photoStart, photoEnd, fullLabel, Blankie.length, filename, BlankiePhotoFile, Group)) %>% 
#   write_csv(file = "./Data/surveys.csv")

# occu
# collected
# photoStart
# photoEnd
# fullLabel
# Blankie.length
# filename
# BlankiePhotoFile
# Group

all <- read_csv("Data/surveys.csv")

all <- all %>% 
  mutate(across(c(occupied, SurveyName), as_factor))


```

### Summaries: silk retreat and spider size

```{r}

retreat_summary <- all %>% 
  group_by(SurveyName) %>% 
  filter(!is.na(BlankieLength)) %>%
  summarise(N_retreat = n_distinct(BlankieID), 
            Mean = mean(BlankieLength),
            SEM = std.error(BlankieLength))

retreat_summary %>% 
  kableExtra::kbl(align = "r") %>% 
  kableExtra::kable_styling(bootstrap_options = "condensed")

spider_summary <- all %>% 
  group_by(SurveyName) %>% 
  filter(!is.na(Prosoma.width)) %>% 
  summarise(N_spider = n(), 
            Mean = mean(Prosoma.width),
            SEM = std.error(Prosoma.width))

spider_summary %>% 
  kableExtra::kbl(align = "r") %>% 
  kableExtra::kable_styling(bootstrap_options = "condensed")


```

### Plot: Spider size over time

#### With labels

```{r}
n_labels_fig1 <- spider_summary %>% pull(N_spider)

all_fig1 <- all %>% 
  mutate(new.SurveyName = factor(surveyId, labels = paste0(levels(SurveyName), "\n", "N = ", n_labels_fig1))) 
```

#### Fig 1

```{r fig.height=4, fig.width=7}

Fig_1L <- all_fig1 %>% 
  select(new.SurveyName, Prosoma.width) %>% 
  ggplot(aes(new.SurveyName, Prosoma.width)) +
  geom_point(aes(group = new.SurveyName), 
    position = position_jitter(width = 0.10), 
    shape = 19, 
    size = 3, 
    alpha = 0.75,
    colour = "#469eb4") +
  stat_summary(fun = "mean", fun.min = "mean", fun.max= "mean", 
               size= 0.7, colour= "#469eb4", alpha = 0.45,  
               geom = "errorbar", width=0.65) + 
  ylab("Prosoma width (mm)") + 
  xlab("") +
  theme_poncho()

Fig_1L
```

### Plot: Retreat building and occupancy over time

Data preparation for the second plot Grabs the survey number from the BlankieID label (this label is given to the blankie when first recorded) checks whether it matches the surveyId (this corresponds to the survey date as categorical) to define if the blankie was new or old (pre-existing) in the current survey time. This trait is stored in the variable "newness"

```{r}
all1 <- all %>% 
  mutate(fpID = str_split(BlankieID, "-", simplify = T)[ ,2], 
         temporal = paste0("0", surveyId), 
         newness = ifelse(fpID == temporal, "new", "old")) %>% 
  mutate(across(c(newness, occupied, SurveyName), as_factor)) %>% 
  mutate(occupied = fct_recode(occupied, Occupied = "TRUE", Vacant = "FALSE"))

```

Adding additional column where to store the combinations between Occupancy and "Newness"

```{r}
# Data preparation for figure

all2 <- all1 %>% 
  mutate(fourLplot = paste0(newness, "_", occupied)) %>% 
  mutate(fourLplot = fct_relevel(fourLplot, "old_Occupied", "old_Vacant", "new_Occupied", "new_Vacant")) %>% 
  mutate(newness = fct_relevel(newness, "old", "new"))

# assigns shapes to each category
shapes_plo1 <- c("old_Occupied" = 19, "old_Vacant" = 1, 
                 "new_Occupied" = 19, "new_Vacant" = 1)

# assigns colours to each category
cols_plo1 <- c("old_Occupied" = "#4682b4", 
               "old_Vacant" = "#4682b4", 
               "new_Occupied" = "#b4464b", 
               "new_Vacant" = "#b4464b")
```

#### With Labels

N labels

This chunk creates all the labels for level of each factor (newness and occupancy)

```{r eval=FALSE, include=FALSE}

# optionally this code can create n values for each category

n_labels_f2_newness.old <- all2 %>%
  filter(!is.na(BlankieLength)) %>%
  filter(newness == "old") %>% 
  select(SurveyName, newness, occupied, BlankieLength) %>% 
  group_by(SurveyName, newness) %>% 
  count() %>% 
  pull(n)
n_labels_f2_newness.old <- c("0", n_labels_f2_newness.old)

n_labels_f2_newness.new <- all2 %>%
  filter(!is.na(BlankieLength)) %>%
  filter(newness == "new") %>% 
  select(SurveyName, newness, occupied, BlankieLength) %>% 
  group_by(SurveyName, newness) %>% 
  count() %>% 
  pull(n)

n_labels_f2_old_vacant <- all2 %>%
  filter(!is.na(BlankieLength)) %>%
  filter(newness == "old", occupied == "Vacant") %>% 
  select(SurveyName, newness, occupied, BlankieLength) %>% 
  group_by(SurveyName, newness, occupied) %>% 
  count() %>% 
  pull(n)
n_labels_f2_old_vacant <- c("0", n_labels_f2_old_vacant)

n_labels_f2_new_vacant <- all2 %>%
  filter(!is.na(BlankieLength)) %>%
  filter(newness == "new", occupied == "Vacant") %>% 
  select(SurveyName, newness, occupied, BlankieLength) %>% 
  group_by(SurveyName, newness, occupied) %>% 
  count() %>% 
  pull(n)
n_labels_f2_new_vacant


all2_fig2 <- all2 %>% 
  mutate(SurveyName = factor(SurveyName)) %>% 
  mutate(new.SurveyName = factor(SurveyName, labels = paste0(levels(SurveyName), "\n", "N = ", n_labels_f2_newness.old, ", ", n_labels_f2_newness.new, "\n", "Vacant = ", n_labels_f2_old_vacant, ", ", n_labels_f2_new_vacant)))

```

Total N labels

```{r}
total_n_survey <- all2 %>%
  filter(!is.na(BlankieLength)) %>%
  select(SurveyName, newness) %>% 
  group_by(SurveyName) %>% 
  count() %>% 
  pull(n)

# add the n label per survey under a line break to each survey name

all2_fig2 <- all2 %>% 
  mutate(new.SurveyName = factor(SurveyName, labels = paste0(levels(SurveyName), "\n", "N = ", total_n_survey)))
```

#### Fig 2L

```{r fig.height=7, fig.width=7, include=T}

fig_2L <- ggplot(all2_fig2) + 
  geom_point(size = 4, alpha = 0.4,  
             aes(new.SurveyName, BlankieLength, 
                 shape = fourLplot, 
                 colour = fourLplot, 
                 group = newness), 
             position = position_jitterdodge(
               jitter.width = 0.50, 
               dodge.width = 0.6 
             )) + 
  guides(color = guide_legend(override.aes = list(size = 7) ) ) +
  
  stat_summary(aes(new.SurveyName, BlankieLength, group = newness), 
               subset(all2_fig2, newness == "old"),
               fun = "mean", fun.min = "mean", fun.max= "mean", 
               size= 0.7, colour= "#4682b4", alpha = 0.80, 
               geom = "errorbar", width=0.30, 
               position = position_nudge(x = -0.15)) +
  
    stat_summary(aes(new.SurveyName, BlankieLength, group = newness), 
               subset(all2_fig2, newness == "new"),
               fun = "mean", fun.min = "mean", fun.max= "mean", 
               size= 0.7, colour= "#b4464b", alpha = 0.80, 
               geom = "errorbar", width=0.30, 
               position = position_nudge(x = 0.15)) +

  scale_shape_manual(name="", values=shapes_plo1, 
                     labels = c(paste0("Pre-existing", "\n", "Occupied"), 
                                 paste0("Pre-existing", "\n", "Vacant"), 
                                 paste0("New", "\n", "Occupied"), 
                                 paste0("New", "\n", "Vacant"))) + 
  scale_colour_manual(name="",
                      values=cols_plo1, 
                      labels = c(paste0("Pre-existing", "\n", "Occupied"), 
                                 paste0("Pre-existing", "\n", "Vacant"), 
                                 paste0("New", "\n", "Occupied"), 
                                 paste0("New", "\n", "Vacant"))) + 
  labs(y = "Retreat length (mm)", x = "Survey time") +
  theme_poncho() +
  theme(plot.caption = element_text(size = 10, hjust = 0)) +
  scale_x_discrete(expand = c(0,0.05))
  
# adding arrows to indicate presence of adult spiders during survey 
fig_2L <- fig_2L + 
  theme(legend.position = c(0.5, 1.05),
        legend.direction = "horizontal",
        plot.margin=unit(c(2,1,1.5,1.2),"cm")) +
  annotate("segment", x = 6, xend = 6, y = 35, yend = 32,
           colour = "black", size = 1, arrow = arrow()) +
  annotate("segment", x = 2, xend = 2, y = 28, yend = 25,
           colour = "black", size = 1, arrow = arrow())

fig_2L

```

Summary, number of records in each category in the plot

```{r}
all2 %>% 
  select(SurveyName, newness, occupied, BlankieLength) %>% 
  group_by(SurveyName, newness, occupied) %>% 
  count() %>% 
  kableExtra::kbl(align = "r") %>% 
  kableExtra::kable_styling(c("striped", "hover")) %>% 
  scroll_box(width = "100%", height = "400px")
```

#### Composite Fig 2

```{r warning=T, fig.widtht=7, fig.heigth=11}

figure_2 <- plot_grid(Fig_1L, fig_2L, ncol=1, align="v", labels = "AUTO", rel_heights = c(1, 2))

```

```{r fig.height=9, fig.width=7}
figure_2
```

```{r eval=FALSE, include=FALSE}
figure_2_margins <- figure_2 +
  theme(plot.margin = unit(c(2.5, 2.5, 2.5, 2.5), "cm"))

# figure_2
# figure_2_margins
 
# ggsave2(filename = "Figure2margins.pdf", plot = figure_2_margins, device = "pdf", path = "./Output", height = 9, units = "in", dpi = 300 )
```

#### 2 Way ANOVA

Data preparation for figure 3

```{r}

colours <- c("Occupied" = "#b4464b", "Vacant" = "#4682b4")

all4.1 <- all %>% 
  mutate(log.B.Area = log10(BlankieArea), 
         log.B.length = log10(BlankieLength)) %>% 
  mutate(SurveyName = as.factor(SurveyName), 
         occupied = as.factor(occupied)) %>% 
  group_by(SurveyName, occupied) %>% 
  summarise(mean=mean(log.B.length, na.rm = TRUE), 
            ci.lwr= norm.interval(log.B.length)[1], 
            ci.upr= norm.interval(log.B.length)[2], 
            .groups = "rowwise")
```

```{r}
figure_3 <- ggplot(all4.1, aes(x=SurveyName, y=mean)) +
  geom_point(aes(x=SurveyName, y=mean, 
                 color = "Occupied"), 
             subset(all4.1, occupied == "TRUE"), 
             size = 3, 
             position = position_nudge(x = 0.1)) + 
  guides(color = guide_legend(override.aes = list(size = 4) ) ) +
  geom_errorbar(aes(x=SurveyName, y=mean, 
                    color = "Occupied", 
                    ymin=ci.lwr, ymax=ci.upr), 
                subset(all4.1, occupied == "TRUE"), 
                width=0.25, 
                size=1, 
                position = position_nudge(x = 0.1)) + 
  geom_point(aes(x=SurveyName, y=mean, 
                 color = "Vacant"), 
             subset(all4.1, occupied == "FALSE"), 
             size = 3, 
             position = position_nudge(x = -0.1)) +
  geom_errorbar(aes(x=SurveyName, y=mean, 
                    color = "Vacant", 
                    ymin=ci.lwr, ymax=ci.upr), 
                subset(all4.1, occupied == "FALSE"), 
                width=0.25, 
                size=1, 
                position = position_nudge(x = -0.1)) + 
  ylab("Log (Retreat length mm)") + 
  xlab("Survey time") +
  scale_colour_manual(name=NULL,values=colours) +
  theme_poncho() +
  theme(legend.position=c(0.5, 0.95), legend.direction = "horizontal")

figure_3
# ggsave2(filename = "figure3.pdf", plot = figure_3, device = "pdf", path = "./Output", width = 7, units = "in", dpi = 300)

```

## Reflectance Spectra

Two datasets created here: 1) Clear data - silk retreats collected from concrete water tank, 2) decorated silk, collected from trees.

### Loading data

```{r}

## "check names = F", stops R from replacing the special characters in the names from the previously exported files

c.specs <-read.csv("Data/clean_specsClear.csv", check.names=FALSE)
c.specs <-as.rspec(c.specs)

d.specs <-read.csv("Data/clean_specsBlankie.csv", check.names=FALSE)
d.specs <-as.rspec(d.specs)

```

### Averaring, smoothing and plotting samples

```{r}
# Average samples > clear
sample <- sub("\\/.*", "", colnames(c.specs))[-1]
mc.specs <- aggspec(c.specs, by = sample, FUN = "mean")
names(mc.specs)[-1] <- unique(sample)

# Average samples > Decorated Blankie
blankie <- sub("\\/.*", "", colnames(d.specs))[-1]
md.specs <- aggspec(d.specs, by = blankie, FUN = "mean")
names(md.specs)[-1] <- unique(blankie)

```

```{r}
# should be performed to the averaged per sample values

# plotsmooth(mc.specs, minsmooth = 0.05, maxsmooth = 0.5, curves = 4, ask = FALSE)
c.specs <- procspec(mc.specs, opt = "smooth", span = 0.05)

# plotsmooth(mtspecs, minsmooth = 0.05, maxsmooth = 0.5, curves = 4, ask = FALSE)
d.specs <- procspec(md.specs, opt = "smooth", span = 0.05)
```

### Plotting samples

```{r}
par(mfrow=c(1, 2))
plot(c.specs, ylim = c(10, 60), main = "Clear silk")
plot(d.specs, ylim = c(10, 60), main = "Decorated silk with debris")
```

### Aggregated spectra plot

```{r}

decorated.B <- sub(".*_", "", colnames(d.specs)[-1])
clear.B <- sub("_.*", "", colnames(c.specs)[-1])
groups <- c(clear.B, decorated.B)

both <- merge(c.specs, d.specs)
names(both)

```

```{r}
# aggplot to visualize the mean reflectance curves for each sample type (i.e. clear blankies = samples and normal debris covered blankies = blankies)
par(mfrow=c(1, 1))
aggplot(both, by = groups, ylim = c(10, 70))
legend(500, 70,
       legend= c("Clear retreats", "Retreats with debris"), 
       y.intersp=0.5, 
       cex = 1.5, 
       pt.cex = 0.5, 
       lty = c(1, 1), 
       col = c("red", "blue"), 
       bty = "n", 
       lwd = 2)
```

### Tidyverse way

```{r}

colour_spec_type <- c("clear" = "red", "debri" = "steelblue")

both %>% 
  rowwise(wl) %>% 
  mutate(mean_clear = mean(c_across(contains("Sample"))),
         sdv_clear = sd(c_across(contains("Sample")))) %>% 
  mutate(mean_debri = mean(c_across(contains("blankie"))),
         sdv_debri = sd(c_across(contains("blankie")))) %>% 
  ggplot(aes(x = wl)) +
  geom_ribbon(aes(ymin = mean_clear-sdv_clear, ymax = mean_clear+sdv_clear), 
              fill = "red",
              alpha = 0.2) +
  geom_line(aes(y = mean_clear, colour = "clear")) + 
  geom_ribbon(aes(ymin = mean_debri-sdv_debri, ymax = mean_debri+sdv_debri), 
              fill = "steelblue",
              alpha = 0.2) +
  geom_line(aes(y = mean_debri, colour = "debri")) +
  expand_limits(y = c(10, 60)) + 
  scale_y_continuous(n.breaks = 10) +
  labs(x = "Wavelength (nm)", y = "Reflectance (%)") +
  scale_colour_manual(name="Silk type", values = colour_spec_type,
                      labels = c("Clear", "With debris")) +
  theme_poncho() 

# ggsave(filename = "clear_vs_debris.pdf", device = "pdf", path = "./Output", width = 7, height = 5)
  

```

## Stats report

```{r}

### 2 Way ANOVA
data <- all %>% 
  filter(!is.na(BlankieLength)) %>% 
  mutate(log.BlankieLength = log10(BlankieLength))

jmv::ANOVA(
  formula = log.BlankieLength ~ SurveyName + occupied + SurveyName:occupied,
  data = data,
  effectSize = "partEta",
  homo = TRUE,
  norm = TRUE,
  postHoc = ~ SurveyName + occupied + SurveyName:occupied,
  postHocES = "d",
  emMeans = ~ SurveyName:occupied,
  emmPlots = FALSE,
  emmTables = TRUE)
rm(data)


### 1 WAY ANOVA
alljam <- 
  all %>% 
  mutate(fpID = str_split(BlankieID, "-", simplify = T)[ ,2], 
         temporal = paste0("0", surveyId), 
         newness = ifelse(fpID == temporal, "new", "old")) %>% 
  filter(SurveyName != "2018-07", 
         SurveyName != "2018-10") %>% 
  filter(newness == "new") %>% 
  mutate(log.BlankieLength = log10(BlankieLength)) %>% 
  mutate(SurveyName = as.character(SurveyName))


jmv::anovaOneW(
  formula = log.BlankieLength ~ SurveyName,
  data = alljam,
  descPlot = TRUE,
  norm = TRUE,
  eqv = TRUE,
  phMethod = "tukey",
  phFlag = TRUE)
rm(alljam)

```
